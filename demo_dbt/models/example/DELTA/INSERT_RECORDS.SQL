{{ config(materialized = 'view') }}

SELECT
    SPOTIFY_UNIQUE_RECORD_KEY,
    SPOTIFY_UNIQUE_PER_INGESTION_RECORD_KEY,
    RAW_FILE_NAME,
    CONVERT(NVARCHAR(32),HashBytes('MD5',CONCAT(
    SPOTIFY_UNIQUE_PER_INGESTION_RECORD_KEY,
    'I'
    )), 2) as SPOTIFY_UNIQUE_PER_INGESTION_META_ACTION_KEY,
    'I' as META_ACTION_CD
FROM {{ ref('staging_final') }}
WHERE INGESTION_DTTM >= (SELECT MAX([INGESTION_DTTM]) FROM {{ ref('NEW_RECORDS') }})
OR (SELECT COUNT(*) FROM {{ ref('NEW_RECORDS') }}) = 0;
